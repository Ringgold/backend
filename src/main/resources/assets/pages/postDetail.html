<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Trader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

    <!-- library -->
    <script src="../js/main.js"></script>
    <script src="../js/jquery.js"></script>

</head>
<body class="w3-light-grey">
<header>
    <ul class="w3-navbar w3-border w3-indigo w3-padding-4">
        <li><a class="w3-hover-indigo w3-text-white w3-hover-text-light-blue" href="/">BookTrader</a></li>
    </ul>
</header>
<br>
<div class="w3-container">
    <div>
        <div class="w3-row-padding">
            <div class="w3-col w3-third">
                <label for="book_title" class="w3-xlarge">BOOK TITLE</label>
            </div>
            <div class="w3-rest w3-right">
                <a id="contact_seller" href="" class="w3-button w3-margin-right w3-btn w3-round w3-green">contact
                    seller</a>
                <a id="print" href="#" onclick="printPost()"><i class="fa fa-print fa-fw w3-text-black w3-xxlarge w3-margin-right"></i></a>
                <button id="edit_book" class="w3-button w3-margin-right w3-btn w3-round w3-green"
                        style="display: none">edit book
                </button>
                <button id="report" class="w3-button w3-margin-right w3-btn w3-round w3-red" href="#" onclick="openReportForm()"
                        style="display:inline-block;">Report Post</button>
            </div>
            <input id="book_title" class="book_information w3-input w3-round w3-border-0 w3-xxlarge w3-white"
                   type="text" disabled
                   style="text-transform:uppercase" required>
            <div class="w3-left w3-third">
                <p>posted by <a id="seller_name" href=""></a></p>
            </div>
            <div class="w3-right w3-rest">
                <p>
                    <span id="views_number">0</span> VIEWS
                </p>
            </div>
        </div>
    </div>
    <div id="pictures">
        <label for="picture_input" class="picture_border w3-center w3-grey w3-border w3-border-black"
               style="width:202px;height:202px;display:inline-block">
            <img class="picture" src="../book.png" height="200"
                 style="max-height: 200px; max-width: 200px; display: inline">
        </label>
        <label for="picture_input" class="picture_border w3-center w3-grey w3-border w3-border-black"
               style="width:202px;height:202px;display:inline-block">
            <img class="picture" src="../book.png" height="200"
                 style="max-height: 200px; max-width: 200px; display: inline">
        </label>
        <label for="picture_input" class="picture_border w3-center w3-grey w3-border w3-border-black"
               style="width:202px;height:202px;display:inline-block">
            <img class="picture" src="../book.png" height="200"
                 style="max-height: 200px; max-width: 200px; display: inline">
        </label>
        <input id="picture_input" type="file" accept="image/*" style="display: none" disabled>
    </div>
    <div class="w3-margin-top" style="padding-left: 30px">
        <div>
            <div class="w3-border-bottom w3-margin-bottom">
                <label for="book_author" class="w3-large">Author</label>
                <input id="book_author" class="book_information w3-input w3-border-0 w3-round w3-white w3-large"
                       type="text" required
                       disabled style="text-transform: uppercase">
            </div>
            <div class="w3-border-bottom w3-margin-bottom">
                <label for="book_price" class="w3-large">Price</label>
                <input id="book_price" class="book_information w3-input w3-border-0 w3-round w3-white w3-large"
                       type="number" step="0.01" required
                       disabled>
            </div>
            <div class="w3-border-bottom w3-margin-bottom">
                <label for="book_ISBN" class="w3-large">ISBN</label>
                <input id="book_ISBN" class="book_information w3-input w3-border-0 w3-round w3-white w3-large"
                       type="text" required disabled>
            </div>
        </div>
        <div>
            <label for="book_description" class="w3-large">Description</label>
            <br>
            <br>
            <textarea cols=80 rows=5 id="book_description" class="w3-large" style="resize: none" disabled required>some description</textarea>
        </div>
    </div>

    <div id="modal-report-form" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
                <span onclick="document.getElementById('modal-report-form').style.display='none'" class="w3-closebtn">&times;</span>
            </header>
            <div class="w3-container">
                <!-- FORM HERE-->
                <h2>Report this post</h2>
                <textarea id="email-report-form" rows="1" cols="51" placeholder="Email. Let blank to stay anonymous"
                          class="w3-border w3-round-large w3-margin-top" type="email" maxlength="51"></textarea>
                <i>Let blank to stay anonymous</i>
                <br>
                <textarea id="content-report-form" rows="5" cols="51" placeholder="Report content... "
                          class="w3-border w3-round-large w3-margin-top" type="text" maxlength="255" required></textarea>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-report-form" class="w3-btn w3-red" onclick="document.getElementById('modal-report-form').style.display='none'">CANCEL</button>
                    <button id="send-report-form" class="w3-btn w3-green" onclick="sendReportForm()">SEND</button>
                </span>
            </footer>
        </div>
    </div>
</div>

<script>
    var book_id = getParameterByName("book_id");
    var book = {};
    var sellerName;
    var sellerEmail;
    var imageHolders = $('.picture');
    var labels = $('.picture_border');
    var currentImageHolder;

    $(labels[0]).on('click', function () {
        currentImageHolder = 0;
    });
    $(labels[1]).on('click', function () {
        currentImageHolder = 1;
    });
    $(labels[2]).on('click', function () {
        currentImageHolder = 2;
    });

    var user_id = sessionStorage.getItem("id");
    $.get('/api/book/addview/' + book_id + '/' + user_id);

    $.get('/api/book/get_book/' + book_id, function (data) {
        book = JSON.parse(data);
        putValue(book);
        var contact_seller = $('#contact_seller');
        var report_button = $('#report');
        var seller_name = $('#seller_name');
        $.get("/api/user/get_user/" + book.seller, function (seller) {
            seller = JSON.parse(seller);
            seller_name.html(seller.name);
            sellerName = seller.name;
            seller_name.attr("href", "/profile?user_id=" + seller.id);
            sellerEmail = seller.email;
        });
        contact_seller.attr('href', '/contact/?book_id=' + book.id);
        var user_id = sessionStorage.getItem("id");
        if (user_id && book.seller === user_id) {
            $('#edit_book').css('display', 'inline');
            contact_seller.hide();
            report_button.hide();
        } else {
            $('#edit_book').hide();
        }
        $.get("/api/book_pic/get_book_pic/" + book_id, function (data) {
            var pics = JSON.parse(data);
            for (var i = 0; i < 3; i++) {
                if (pics[i]) {
                    $(imageHolders[i]).attr("src", pics[i].picture);
                    $(imageHolders[i]).taken = true;
                } else {
                    $(labels[i]).hide();
                    $(imageHolders[i]).taken = false;
                }
            }
        })
    });

    //$('#edit_book').css('display', 'inline');

    var fileReader = new FileReader();
    fileReader.onload = function (event) {
        $(imageHolders[currentImageHolder]).attr("src", event.target.result);
    };

    $('input[type=file]').on('change', function () {
        var files = $(this)[0].files;
        var picture = files[0];
        fileReader.readAsDataURL(picture);
    });

    var edit_book = $('#edit_book');
    edit_book.html("edit book");
    var inputs = $('.book_information');
    inputs.on('keyup', checkValidation);
    inputs.on('blur', checkValidation);

    edit_book.on('click', function () {
        if ($(this).html() === 'edit book') {
            toggleEditable();
            $(this).html('save');
        } else {
            var validate = true;
            for (var i = 0; i < inputs.length; i++) {
                validate = validate && inputs[i].checkValidity();
            }
            if (!validate) {
                alert("the information is not valid");
                return;
            }
            var price_input = $('input[id=book_price]');
            var price = price_input.val();
            price = Number(price).toFixed(2);
            price_input.val(price);
            var response = confirm("are you sure you want to update the information?");
            if (response === true) {
                getValue(book);
                $.post('/api/book/update', JSON.stringify(book), function (data) {
                    if (data === 'SUCCESS') {
                        var srcList = [];
                        for (var i=0;i<3;i++) {
                            var src = $(imageHolders[i]).attr("src");
                            if (src !== "../book.png") {
                                var template = {};
                                template.book_id = book_id;
                                template.picture = src;
                                srcList.push(template);
                            }
                        }
                        $.post('/api/book_pic/update', JSON.stringify(srcList), function(data) {
                            if (data === "SUCCESS") {
                                alert(data);
                                location.reload();
                            } else {
                                alert("image upload failed");
                                location.reload();
                            }
                        })
                    } else {
                        alert(data);
                        location.reload();
                    }
                });
            } else {
                location.reload();
            }
        }
    });

    function checkValidation(e) {
        var validate = e.target.checkValidity();
        if (!validate) {
            $(this).addClass("w3-pale-red");
            if ($(this).hasClass("w3-pale-green")) {
                $(this).removeClass("w3-pale-green");
            }
        } else {
            if ($(this).hasClass("w3-pale-red")) {
                $(this).removeClass("w3-pale-red");
            }
            $(this).addClass("w3-pale-green");
        }
    }

    function toggleEditable() {
        for (var i = 0; i < 3; i++) {
            $(labels[i]).show();
        }
        inputs.removeClass("w3-border-0");
        inputs.addClass("w3-border");
        inputs.addClass("w3-border-blue");
        inputs.attr("disabled", false);
        $('input[type=file]').attr("disabled", false);
        labels.removeClass("w3-border-black");
        labels.addClass("w3-border-blue");
        inputs.removeClass("w3-white");
        $('textarea').attr("disabled", false);
    }

    function putValue(book) {
        $('input[id=book_title]').val(book.title);
        $('input[id=book_author]').val(book.author);
        $('input[id=book_price]').val(book.price.toFixed(2));
        $('input[id=book_ISBN]').val(book.code);
        $('#book_description').val(book.description);
        $('#views_number').html(book.views);
    }

    function getValue(book) {
        book.title = $('input[id=book_title]').val();
        book.author = $('input[id=book_author]').val();
        book.price = $('input[id=book_price]').val();
        book.code = $('input[id=book_ISBN]').val();
        book.description = $('#book_description').val();
        if (book.description === "") {
            book.description = sellerName + " is lazy and didn't write the description! Don't buy the book!"
        }
    }

    function printPost() {
        window.print();
    }

    function openReportForm(){
        if (!sessionStorage.getItem('id')) {
            alert("Please log in first, you can still report anonymously!");
        }else{
            $('#email-report-form').val(sessionStorage.getItem("email"));
            document.getElementById('modal-report-form').style.display = 'block';
        }
    }

    function sendReportForm() {
        document.getElementById('send-report-form').textContent = "SENDING REPORT...";
        document.getElementById('send-report-form').disabled = true;

        var data = {};
        data.content = $('#content-report-form').val();

        data.sellerEmail = sellerEmail;
        data.userName = sellerName;
        if($('#email-report-form').val() == null){
            data.userEmail = "null";
        }else{
            data.userEmail = $('#email-report-form').val();
        }
        $.post('/api/mail/report', JSON.stringify(data), function(response) {
            $('#send-report-form').disabled = false;
            if (response === 'SUCCESS') {
                document.getElementById('modal-report-form').style.display = 'none';
                alert("Message successfully sent.");
            } else {
                alert("please try again");
            }
            location.reload();
        });
    }
</script>
</body>
</html>