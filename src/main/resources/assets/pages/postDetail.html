<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Trader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

    <!-- library -->
    <script src="../js/main.js"></script>
    <script src="../js/jquery.js"></script>

</head>
<body class="w3-light-grey">
<header>
    <ul class="w3-navbar w3-border w3-indigo w3-padding-4">
        <li><a class="w3-hover-indigo w3-text-white w3-hover-text-light-blue" href="/">BookTrader</a></li>
    </ul>
</header>
<br>
<br>
<div class="w3-row-padding">

    <div class="w3-half">
        <!-- img src="https://images-na.ssl-images-amazon.com/images/I/51QdG2avTDL._AC_UL320_SR246,320_.jpg" alt="imageofbook" class="w3-image w3-card-4" -->
        <h1 id="title"><!-- book title --></h1>
        <br>
        <table class="w3-table-all w3-hoverable" style="width:auto">
            <tr>
                <td>Author</td>
                <td id="author"><!-- author name --></td>
            </tr>
            <tr>
                <td>Price &nbsp; <a id="price-edit" href="#" onclick="displayEditPrice()" hidden><i class="fa fa-pencil-square" ></i></a></td>
                <td id="price"><!-- $$$ --></td>
            </tr>
            <tr>
                <td>ISBN</td>
                <td id="isbn"><!-- ISBN code --></td>
            </tr>
        </table>
        <br>
        <p>
            &nbsp;&nbsp;&nbsp;Posted by <a id="seller" href="/profile" target="_blank"> [seller's username] </a>
        </p>
    </div>

    <div class="w3-half">
        <a id="contact" class="w3-button w3-margin-right w3-margin-top w3-btn w3-round w3-green" href="/contact">Contact Seller</a>
        <br>
        <br>
        <h4> Description <a id="desc-edit" href="#" onclick="displayEditDescription()" hidden><i class="fa fa-pencil-square" ></i></a> </h4>
        <p id="description">
            <!-- Description of the book (written by seller) -->
        </p>
    </div>

    <div id="modal-price-edit" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-price-edit').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Edit Price</h2>
            </header>
            <div class="w3-container">
                <p>
                    <input name="price" class="w3-input w3-border w3-round-large w3-margin-top" type="text">
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-price" class="w3-btn w3-red" onclick="closeEditPrice()">CANCEL</button>
                    <button id="save-price" class="w3-btn w3-green" onclick="saveEditPrice()">SAVE</button>
                </span>
            </footer>
        </div>
    </div>

    <div id="modal-description-edit" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-description-edit').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Edit Description</h2>
            </header>
            <div class="w3-container">
                <p>
                    <input name="description" class="w3-input w3-border w3-round-large w3-margin-top" type="text">
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-description" class="w3-btn w3-red" onclick="closeEditDescription()">CANCEL</button>
                    <button id="save-description" class="w3-btn w3-green" onclick="saveEditDescription()">SAVE</button>
                </span>
            </footer>
        </div>
    </div>

    <script>
        function saveEditPrice() {
            var price = $('input[name="price"]').val();
            if (price && price != $('#price').html()) {
                updateBook(price, $('#description').html());
            }
            closeEditPrice();
        }

        function saveEditDescription() {
            var desc = $('input[name="description"]').val();
            if (desc && desc != $('#description').html()) {
                updateBook($('#price').html(), desc);
            }
            closeEditDescription();
        }

        function closeEditDescription() {
            document.getElementById('modal-description-edit').style.display='none';
        }

        function closeEditPrice() {
            document.getElementById('modal-price-edit').style.display='none';
        }

        function displayEditDescription() {
            document.getElementById('modal-description-edit').style.display='block';
            $('input[name="description"]').val($('#description').html());
        }

        function displayEditPrice() {
            document.getElementById('modal-price-edit').style.display='block';
            $('input[name="price"]').val($('#price').html());
        }

        function updateBook(price, description) {
            if (/^\d*(\.\d{2})?$/.test(price) || !description || description == "") {
                var userId = sessionStorage.getItem('id');
                var bookId = sessionStorage.getItem('book_id');

                var updatedBook = {
                    id: bookId,
                    price: price,
                    description: description,
                    seller: userId
                }

                $.post("/api/book/update", JSON.stringify(updatedBook), function (result) {
                    if (result == 'SUCCESS') {
                        window.location.reload();
                    } else {
                        alert('Book update failed.');
                    }
                })

            } else {
                alert('Invalid price! Price should be in one of those forms: xx, x, xx.xx, x.xx | Not accepted are: x.x, xx.x');
            }
        }

        var bookId = getParameterByName("book_id");
        $.get("/api/book/get_book/" + bookId, function(response) {
            if (response === 'FAIL') {
                alert("failed");
                return;
            }
            var book = JSON.parse(response);

            if (/^\d*$/.test(book.price)) {
                book.price = "" + book.price + ".00";
            } else if (/^\d*\.\d$/.test(book.price))  {
                book.price = "" + book.price + "0";
            }

            // If currently logged in user is the poster of the displayed book,
            // edit buttons must be visible
            if (sessionStorage.getItem('id') === book.seller) {
                $('#price-edit').removeAttr('hidden');
                $('#desc-edit').removeAttr('hidden');
                document.getElementById('contact').style.visibility='hidden';
            }

            $('#title').html(book.title);
            $('#author').html(book.author);
            $('#price').html(book.price);
            $('#isbn').html(book.code);
            $('#description').html(book.description);
            $.get("/api/user/get_user/" + book.seller, function(response) {
                var user = JSON.parse(response);
                $('#seller').html(user.name);
            })
        });
    </script>
</div>
</body>
</html>