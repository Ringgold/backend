<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <script src="../js/main.js"></script>
    <script src="../js/jquery.js"></script>
</head>

<header>
    <ul class="w3-navbar w3-border w3-indigo w3-padding-4">
        <li><a class="w3-hover-indigo w3-text-white w3-hover-text-light-blue" href="/">BookTrader</a></li>
    </ul>
</header>
<br>

<body class="w3-white">

<div class="w3-container" id="main">
    <header class="w3-container w3-padding-32 w3-center w3-light-grey" id="username">
        <h1 class="w3-jumbo"><span id="user_name">I'm</span></h1>
    </header>

    <div class="w3-content">
        <h2>About Me</h2>
        <a id="about-me-edit" href="#" onclick="$('#modal-about-me-edit').show();"><i
                class="fa fa-pencil-square"></i></a>
        <p id="about_me"> Some text about me. </p>
        <br>
        <h2>My Rating</h2>
        <p class="w3-wide">Reputation: <span id="rating"></span></p>
        <br>
        <h2>My Posts</h2>
        <a id="my_books" href="#" class="w3-btn w3-white w3-border w3-border-green w3-round">CLICK ME TO SEE THE
            POSTS</a>
        <br>
    </div>

    <!-- Rate Me Section-->
    <div class="w3-content" id="rate_me">
        <h2>Rate Me</h2>
        <p>Select a rating: </p>
        <select name="Rating" id="rate_val">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
        <br>
        <br>
        <a class="w3-btn w3-white w3-border w3-border-green w3-round" href="#" onclick="rateSeller()">SUBMIT</a>
    </div>

    <div class="w3-content">
        <br>
        <br>
        <h2>Contact Me</h2>
        <div class="w3-section">
            <p>
                <i class="fa fa-phone fa-fw w3-text-black w3-xlarge w3-margin-right"></i>
                <a id="phone-edit" href="#" onclick="$('#modal-phone-edit').show();"><i class="fa fa-pencil-square"></i></a>
                <span id="phone_number"></span>
            </p>
        </div>
    </div>

    <div id="change-password-section" class="w3-content">
        <br>
        <br>
        <h2>Password Edition</h2>
        <div class="w3-section">
            <p>
                <a id="change-password-button" href="#" onclick="$('#modal-password-edit').show();" class="w3-btn w3-white w3-border w3-border-green w3-round">CHANGE MY PASSWORD</a>
            </p>
        </div>
    </div>

    <div id="delete-account-section" class="w3-content">
        <br>
        <br>
        <h2>Account Deletion</h2>
        <div class="w3-section">
            <p>
                <a id="delete-account-confirmation-button" href="#" onclick="$('#modal-account-deletion-confirmation').show();" class="w3-btn w3-white w3-border w3-border-green w3-round">DELETE MY ACCOUNT</a>
            </p>
        </div>
    </div>

    <div id="modal-about-me-edit" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-about-me-edit').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Edit About Me</h2>
            </header>
            <div class="w3-container">
                <p>
                    <input name="about_me" title="about_me" class="w3-input w3-border w3-round-large w3-margin-top"
                           type="text">
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-aboutme" class="w3-btn w3-red"
                            onclick="document.getElementById('modal-about-me-edit').style.display='none'">CANCEL</button>
                    <button id="save-aboutme" class="w3-btn w3-green" onclick="saveEditAboutMe()">SAVE</button>
                </span>
            </footer>
        </div>
    </div>

    <div id="modal-phone-edit" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-phone-edit').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Change Phone Number</h2>
            </header>
            <div class="w3-container">
                <p>
                    <input name="phone" title="phone" class="w3-input w3-border w3-round-large w3-margin-top"
                           type="text">
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-phone" class="w3-btn w3-red"
                            onclick="document.getElementById('modal-phone-edit').style.display='none'">CANCEL</button>
                    <button id="save-phone" class="w3-btn w3-green" onclick="saveEditPhone()">SAVE</button>
                </span>
            </footer>
        </div>
    </div>

    <div id="modal-password-edit" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-password-edit').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Edit Password</h2>
            </header>
            <div class="w3-container">
                <p>
                    Previous password
                    <br>
                    <input name="previous_password" title="previous_password" class="w3-input w3-border w3-round-large w3-margin-top"
                           type="password" required>
                    <br>
                    New password
                    <br>
                    <input name="new_password" title="new_password" class="w3-input w3-border w3-round-large w3-margin-top"
                           type="password" required>
                    <br>
                    Confirm new password
                    <br>
                    <input name="confirmation_new_password" title="confirmation_new_password" class="w3-input w3-border w3-round-large w3-margin-top"
                           type="password" required>
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-password" class="w3-btn w3-red"
                            onclick="document.getElementById('modal-password-edit').style.display='none'">CANCEL</button>
                    <button id="save-password" class="w3-btn w3-green" onclick="changePassword()">CHANGE MY PASSWORD</button>
                </span>
            </footer>
        </div>
    </div>

    <div id="modal-account-deletion-confirmation" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-indigo">
        <span onclick="document.getElementById('modal-account-deletion-confirmation').style.display='none'"
              class="w3-closebtn">&times;</span>
                <h2>Confirm Account Deletion</h2>
            </header>
            <div class="w3-container">
                <p>
                    Are you sure you want to delete your account? This action is irreversible.
                    <br>
                    All your account information and all your posts will be deleted.
                </p>
            </div>
            <footer class="w3-container w3-indigo">
                <span class="w3-right w3-padding-8">
                    <button id="cancel-delete-account" class="w3-btn w3-red"
                            onclick="document.getElementById('modal-account-deletion-confirmation').style.display='none'">CANCEL</button>
                    <button id="delete-account-button" class="w3-btn w3-green" onclick="deleteAccount()">DELETE MY ACCOUNT</button>
                </span>
            </footer>
        </div>
        
    </div>

    <script>
        var myId = sessionStorage.getItem("id");
        var userId = getParameterByName("user_id");
        if (myId) {
            if (myId !== userId) {
                $('#phone-edit').hide();
                $('#about-me-edit').hide();
                $('#email-edit').hide();
                $('#delete-account-section').hide();
                $('#change-password-section').hide();
            } else {
                $('#rate_me').hide();
            }
        } else {
            $('#phone-edit').hide();
            $('#about-me-edit').hide();
            $('#email-edit').hide();
            $('#delete-account-section').hide();
            $('#change-password-section').hide();
        }
        $.get("/api/profile/get_seller_profile_by_user_id/" + userId, function (data) {
            data = JSON.parse(data);
            var profile = {};
            profile.about_me = data.about_me;
            profile.phone_number = data.phone_number;
            profile.rating = data.rating;
            profile.rating_count = data.rating_count;
            profile.user_id = data.user_id;
            $('#about_me').html(profile.about_me);
            $('#phone_number').html(profile.phone_number);
            $('#my_books').attr("href", "/my_books/?user_id=" + profile.user_id);
            if (profile.rating_count < 1) {
                $('#rating').html("no one has rated yet!");
            } else {
                $('#rating').html(profile.rating);
            }
        });

        $.get("/api/user/get_user/" + userId, function (data) {
            data = JSON.parse(data);
            $('#user_name').html("I'm " + data.name);
        });

        function rateSeller() {
            var response = confirm("Are you sure you want to rate this user?");
            if (response == true) {
                var rate_val = $('#rate_val').val();
                rate_val = parseFloat(rate_val);
                $.get('/api/profile/update_rating/' + userId + '/' + rate_val, function (data) {
                    alert(data);
                    window.location.reload();
                });
            }
        }

        function saveEditAboutMe() {
            var about_me = $('input[title="about_me"]').val();
            if (about_me && about_me !== $('#about_me').html()) {
                $.get('/api/profile/update_about_me_by_user_id/' + myId + '/' + about_me, function (data) {
                    alert(data);
                    window.location.reload();
                });
            }
        }

        function saveEditPhone() {
            var phone_number = $('input[title="phone"]').val();
            phone_number = Number(phone_number);
            if (phone_number && phone_number !== $('#phone_number').html()) {
                $.get('/api/profile/update_phone_number_by_user_id/' + myId + '/' + phone_number, function (data) {
                    alert(data);
                    window.location.reload();
                });
            } else {
                alert("the input format is wrong");
            }
        }

        function deleteAccount() {
            $.get('/api/user/delete/' + myId, function (data) {
                alert(data);
                shareLogout();
                sessionStorage.clear();
                window.location.href = "/";
            });
        }

        function changePassword(){
            var oldPassword = $('input[title="previous_password"]').val();
            var newPassword = $('input[title="new_password"]').val();
            var confirmationNewPassword = $('input[title="confirmation_new_password"]').val();
            $.get('/api/user/changePassword/' + myId + '/' + oldPassword + '/' + newPassword, function(data) {
                if(confirmationNewPassword === newPassword){
                    alert(data);
                    $('input[title="previous_password"]').val('');
                    $('input[title="new_password"]').val('');
                    $('input[title="confirmation_new_password"]').val('');
                    document.getElementById('modal-password-edit').style.display='none';
                }else{
                    alert("The confirmation password doesn't correspond");
                }
            });
        }
    </script>
    
</div>
<div class="w3-left w3-third">
    <p><a id="policies_terms" href="https://www.silentdoor.net/help"><b>Policies and Terms of Use</b></a></p>
</div>
</body>
</html>
